---
sudo: false
language: ruby
rvm:
  - 2.5.1
services:
  - postgresql
env:
  - TZ=America/New_York

before_install:
  - gem update --system
  - gem install bundler

before_script:
  - psql -c "create role funcake with createdb login password 'password';" -U postgres
  - RAILS_ENV=test bundle exec rake db:setup
  - RAILS_ENV=test bundle exec rake db:seed
  - RAILS_ENV=test bundle exec rake db:migrate
  - nvm install node
  - npm install -g ajv
  - npm install -g ajv-cli

script:
  # please add here however you run your test suite
  - true

after_success:
  - true

before_deploy:
  - rm -fR $PYENV_ROOT
  - curl https://pyenv.run | bash
  - pyenv install -v 3.7.2
  - pyenv local 3.7.2
  - pip install pipenv
  - pipenv install
  - openssl aes-256-cbc -K $encrypted_1ff19d4df34f_key -iv $encrypted_1ff19d4df34f_iv -in .travis/deploy.zip.enc -out .travis/deploy.zip -d
  - unzip .travis/deploy.zip -d .travis
  - mv .travis/.gritty_travis ~/.ssh/.gritty_travis
  - mv .travis/.conan_the_deployer ~/.ssh/.conan_the_deployer
  - eval "$(ssh-agent -s)"
  - chmod 600 ~/.ssh/.gritty_travis
  - chmod 600 ~/.ssh/.conan_the_deployer
  - echo -e "Host $DEV_SERVER\n\tStrictHostKeyChecking no\n\tIdentityFile ~/.ssh/.conan_the_deployer\n" >> ~/.ssh/config
  - echo -e "Host $PROD_SERVER\n\tStrictHostKeyChecking no\n\tIdentityFile ~/.ssh/.conan_the_deployer\n" >> ~/.ssh/config
  - echo -e "HOST gitserv\n\tHostname remote.server.com\n\tIdentityFile ~/.ssh/.gritty_travis\n\tIdentitiesOnly yes\n" >> ~/.ssh/config
  - echo -e "HOST github.com\n\tIdentityFile ~/.ssh/.gritty_travis\n" >> ~/.ssh/config
  - ssh-add ~/.ssh/.gritty_travis
  - ssh-add ~/.ssh/.conan_the_deployer

deploy:
  - provider: script
    script: bash .travis/deploy-dev.sh
    on:
      branch: dev
  - provider: script
    script: bash .travis/deploy-prod.sh
    on:
      branch: master

notifications:
  slack:
    secure: z6UU1WNCrXgtBohGmts6+dY11pQzoQi9bY3WlNVL9ce0M81HNhUE+5SjjSECWxUBLakiazhp5g3K6sTodXESozz918T0oT8RoXF1dbWjD/Q/DT130nszze8UTmRZL+nOaA5bwGNgdGxV+iAHs8RycqshCuikJHTms1ndyn0y2h8jYAO2ImD/cuvcX9gM2Lxq4KIZJGO5ApAi+JqxFdawo43Hnmc/VRyA3aS8izZseZcta+nVoipAL21CVucXlCqVMKkEeflutr4NDhj8WbqdQONArzs7VUVk1TtUP1NXNrhJyZmG9ZhM/3fo3Infq8+vZk8XOGTrqroJUhY8uw6KOQXWw05we/CZuRDsql4mmKKOMUtHg/uUU32U0HRDSHrQs+gY1U89j2TOtdcRzmmbPMhpz70yRf5HnFaMSrzfSsDbkNb/M51NDfv5dikZ44dsXOYDWT6MA1EqWkEOC0pdrygmS4WWRZgW3gpo97ea8GezFWFvw77oAiOH+iYo/rb39y6S5wnHiMACGdubH8O8AULH4qqOAQR4C5ZEcJMDbmI2KfWtq3DGyWASwol4xeOhYq/339GkFGLYUd6yc48Adl8ZrkweaIw+EV10X8HxqzPEG7T1srzLt/IH8fhUV+HTGbpbQyldBzrNa/XnmATEWEfyONXqzlfMzmgCe4tJ/38=
    on_pull_requests: false
    on_success: change
    on_failure: always
